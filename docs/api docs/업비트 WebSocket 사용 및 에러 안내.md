# WebSocket 사용 및 에러 안내

업비트 WebSocket 연결 및 데이터 수신을 위한 사용 안내입니다.

## Endpoint

업비트 WebSocket Endpoint는 아래와 같습니다. 조회하고자 하는 데이터의 분류에 따라 세부 Endpoint가 구분됩니다.

- 시세(Quotation): wss://api.upbit.com/websocket/v1

- 자산 및 주문(Exchange): wss://api.upbit.com/websocket/v1/private

## 인증

Exchange 데이터를 수신하기 위해 WebSocket을 wss://api.upbit.com/websocket/v1/private 도메인으로 연결하는 경우 인증이 필요합니다. 인증 가이드를 참고하여 생성한 JWT 토큰을 Authorization 헤더에 반드시 포함하여 요청해야 합니다. Bearer 인증을 지원하며, 아래와 같은 형식으로 입력합니다.

Authorization: Bearer eyJhb...d8sTw

WebSocket 클라이언트 사용 시 헤더 설정을 지원하지 않을 수 있습니다.
wscat과 같은 일부 WebSocket 클라이언트들은 커스텀 헤더 설정을 지원하지 않으므로 Exchange 데이터 수신 확인이 어려울 수 있습니다. 클라이언트 선택 전 헤더 지원 여부를 확인하시고, 필요한 경우 아래 구현 가이드를 참고하여 구현 후 사용하시기를 권장드립니다.

## 에러 안내

WebSocket 연결 후 요청에 대한 에러 발생 시, 응답은 다음과 같은 JSON 형식으로 반환됩니다.

```json
{
  "error": {
    "name": "ERRPR_CODE",
    "message": "ERROR_MESSAGE"
  }
}
```

반환될 수 있는 주요 에러 코드 목록은 아래와 같습니다.

error.name	발생 이유
INVALID_AUTH	인증 정보 누락 또는 인증 토큰 검증 실패
WRONG_FORMAT	요청 형식 위반
NO_TICKET	티켓 필드 누락
NO_TYPE	타입 필드 누락
NO_CODES	코드 필드 누락
INVALID_PARAM	필수 요청 파라미터 누락 또는 지원하지 않는 값 요청

## 데이터 항목

업비트 WebSocket을 통해 조회 및 구독할 수 있는 데이터 항목은 다음과 같습니다.

데이터 항목(type)	설명	지원 형식

ticker	현재가 데이터 수신	스냅샷, 실시간 스트림

trade	체결 데이터 수신	스냅샷, 실시간 스트림

orderbook	호가 데이터 수신	스냅샷, 실시간 스트림

candle.{unit}	캔들(초봉, 분봉) 데이터 수신	스냅샷, 실시간 스트림

myAsset	내 자산 데이터 수신	실시간 스트림

myOrder	내 주문 데이터 수신	실시간 스트림

## 데이터 유형

WebSocket을 통해 수신할 수 있는 데이터는 스냅샷 데이터와 실시간 스트림의 두가지 유형으로 구분됩니다.

스냅샷 데이터란, 요청 시점의 정보를 1회 수신하는 방식입니다.

실시간 스트림은 WebSocket 연결이 유지되는 동안 지속적으로 정보가 수신되는 방식으로, 데이터 항목에 따라 일정한 갱신 주기마다 또는 이벤트가 발생하는 시점에 정보를 수신할 수 있습니다. 
- 일정한 갱신 주기에 도달한 경우 or 데이터가 변경되는 경우. 

사용자는 WebSocket 채널을 통해 서버로 스냅샷 데이터와 실시간 스트림 데이터 전송을 요청하는 메세지를 송신할 수 있으며, 특정 유형의 데이터만을 요청할 수도 있습니다. 항목 별로 지원하는 데이터 유형을 확인하고 용도에 맞게 조회하여 사용하시기 바랍니다.

## 요청 메세지의 구조와 형식

데이터 전송 요청 메세지는 JSON Array형식으로, 아래와 같은 JSON Object들을 포함해야 합니다.

### Ticket Object

배열의 첫번째 요소로 Ticket Object를 입력합니다. Ticket Object 명세는 아래와 같습니다.

필드명	형식	필수 여부	설명
ticket	String	Required	요청 티켓의 고유 식별자. UUID 등 고유성을 보장하는 문자열을 사용합니다.

### Data Type Object

배열의 두번째 요소 부터 조회하고자 하는 데이터 요청 Object를 입력합니다. 2개 이상의 Object를 입력하여 동시에 여러 데이터를 요청 및 수신할 수 있습니다. 데이터 구독 요청의 공통 필드인 type 필드를 제외한 항목별 요청 Object 명세와 응답 명세는 항목별 Reference 문서를 참고해주시기 바랍니다.

필드명	형식	필수 여부	설명
type	String	Required	수신하고자 하는 데이터 항목. ticker, trade, orderbook, candle.{unit}, myAsset, myOrder 중 하나를 입력할 수 있습니다.
codes	String	Conditional	조회하고자 하는 페어 목록. type 필드가 ticker, trade, orderbook, candle.{unit} 인 경우 필수(Required), myOrder인 경우 선택적으로 사용할 수 있습니다.
level	String	Optional	호가 모아보기 단위. type 필드가 orderbook인 경우에만 선택적으로 사용할 수 있습니다.
is_only_snapshot	String	Optional	스냅샷만 요청. type 필드가 ticker, trade, orderbook, candle.{unit} 인 경우에만 선택적으로 사용할 수 있습니다.
is_only_realtime	String	Optional	실시간 스트림만 요청. type 필드가 ticker, trade, orderbook, candle.{unit} 인 경우에만 선택적으로 사용할 수 있습니다.

### Format Object
배열의 마지막 요소로 Format Object를 입력합니다. 설정에 따라 일반 포맷, SIMPLE 포맷, 또는 배열 포맷으로 데이터를 수신할 수 있습니다. SIMPLE 포맷은 각 필드의 key 값이 축약어 형태로 반환되는 포맷입니다. 예를 들어 market 필드는 mk으로 표기됩니다. 많은 데이터를 수신하여 데이터 사이즈를 줄이고자 하는 경우 유용하게 사용할 수 있습니다. Format Object 명세는 아래와 같습니다.

### 요청 예제

#### 단일 Ticket 스냅샷/실시간 스트림 조회 요청 
```json
[
  {"ticket":"3e2c4a9f-f0a7-457f-945e-4b57bde9f1ec"},	
  {"type":"ticker","codes":["KRW-BTC"]}
]
```

#### Trade, Orderbook 스냅샷/실시간 스트림 SIMPLE 포맷 조회 요청

```json
[
  {"ticket":"9a65cd93-8786-4202-9b13-bd90e0c8b64b"},
  {"type":"trade","codes":["KRW-BTC","BTC-BCH"]},
	{"type":"orderbook","codes":["KRW-BTC","BTC-BCH"]},
  {"format":"SIMPLE"}
]
``` 

## 연결 관리
업비트 WebSocket 서버는 안정적인 연결 관리와 유지를 위한 PING/PONG Frame을 지원합니다.

### Ping/Pong 프레임 

Ping/Pong 프레임은 웹소켓 연결이 살아있는지 서로 확인하기 위해 주고받는 **'생존 신호'**입니다.

클라이언트와 서버가 오랫동안 아무 데이터를 주고받지 않으면, 서로 연결이 끊겼는지 알 방법이 없습니다. 이 문제를 해결하기 위해 사용하는 것이 바로 Ping/Pong 매커니즘입니다.

Ping (핑 핑 👉): 클라이언트가 서버에게 "잘 있니?"라고 보내는 신호입니다.

Pong (퐁 퐁 👈): 서버가 Ping을 받으면 "응, 잘 있어!"라고 즉시 응답하는 신호입니다.

### 업비트 웹소켓의 연결 관리 매커니즘

업비트는 이 Ping/Pong 개념을 사용해 안정적으로 연결을 관리합니다.

120초 Idle Timeout (자동 연결 종료)
- 클라이언트와 서버 사이에 아무런 데이터(주문, 시세 등)나 Ping 신호가 120초 동안 오고 가지 않으면, 서버는 "이 연결은 유령 연결이구나"라고 판단하고 연결을 강제로 끊어버립니다.

연결 유지 방법 ①: Ping Frame (정석)
- 이 자동 종료를 막기 위해, 클라이언트는 주기적으로 서버에 Ping Frame을 보냅니다.
- 서버는 Ping을 받으면 Pong으로 응답하며, 이 신호를 주고받는 것만으로 '데이터가 오고 간 것'으로 처리되어 120초 타임아웃이 초기화됩니다.
- 대부분의 최신 웹소켓 라이브러리에는 이 기능이 내장되어 있어 간단한 설정만으로 자동 실행됩니다.

연결 유지 방법 ②: "PING" 텍스트 메시지 (대안)
- 만약 사용하는 클라이언트가 Ping Frame을 직접 보내는 기능을 지원하지 않는다면, 대안으로 그냥 텍스트 메시지 **"PING"**을 서버에 보낼 수 있습니다.
- 서버는 이 텍스트를 받으면 연결이 유지되고 있다고 판단하고, 응답으로 10초마다 {"status":"UP"} 메시지를 보내줍니다. 이는 연결이 정상임을 시각적으로 확인시켜주는 역할을 합니다.

```shell
$ telsocket -url wss://api.upbit.com/websocket/v1
Connected!
PING
{"status":"UP"}
{"status":"UP"}
{"status":"UP"}
...
```

### Ping/Pong 외의 연결 관리 전략들

Ping/Pong이 저수준(low-level)에서 연결을 확인한다면, 다음과 같은 전략들은 애플리케이션 수준에서 안정성을 높이는 방법들입니다.

자동 재연결 (Automatic Reconnection): 클라이언트 측에서 연결이 끊어졌을 때를 감지(onclose 이벤트)하고, 자동으로 다시 연결을 시도하는 로직을 구현합니다.
- 백오프(Backoff) 전략: 재연결 시도 시 매번 즉시 붙는 게 아니라, 실패할수록 시도 간격을 점차 늘려(예: 1초 -> 2초 -> 4초 뒤 시도) 서버에 과부하를 주지 않는 것이 중요합니다.
- 상태 동기화 및 복구: 재연결이 성공했을 때, 연결이 끊겨 있던 동안 놓친 데이터가 있는지 서버에 확인하고 받아와서 상태를 복구하는 로직이 필요합니다.
- 메시지 브로커 (Message Broker) 활용: 여러 대의 서버로 시스템을 확장할 때, 특정 서버에 연결된 사용자가 다른 서버에 연결된 사용자에게 메시지를 보낼 수 있도록 중간에서 메시지를 중개해주는 시스템(예: Redis Pub/Sub, RabbitMQ, Kafka)을 사용합니다. 이는 서버 한 대가 다운되어도 다른 서버를 통해 연결을 유지할 수 있게 돕습니다.

#### Uber는 웹소켓을 어떻게 쓰고 관리할까?

Uber의 관리 방식:

전용 웹소켓 서비스 운영: Uber는 라이더용과 드라이버용 웹소켓 서비스를 분리하여 독립적으로 확장하고 관리합니다.
- Ping/Pong 활용: 당연히 기본적인 연결 유지를 위해 Ping/Pong 매커니즘을 사용합니다. 이를 통해 불안정한 모바일 네트워크 환경에서도 연결 상태를 계속 확인합니다.
- 자동 재연결 및 백오프: 클라이언트(앱)에 강력한 재연결 로직을 구현하여, 터널에 들어가거나 네트워크가 잠시 불안정해져도 최대한 빨리 연결을 복구하도록 합니다.
- 최신 기술 도입: 최근 Uber는 전통적인 웹소켓을 넘어, 더 빠르고 효율적인 QUIC / HTTP/3와 같은 최신 프로토콜을 도입하여 실시간 통신의 성능을 더욱 향상시키고 있습니다.
- 폴링(Polling)을 예비 수단으로: 웹소켓 연결이 어려운 아주 불안정한 네트워크 환경을 대비해, 예전 방식처럼 주기적으로 서버에 정보를 물어보는 HTTP 폴링(Polling) 방식을 예비(fallback) 수단으로 사용하기도 합니다.

#### 자동 재연결 방식 좀 더 자세하게: 

자동 재연결은 클라이언트(앱, 웹페이지)가 서버와의 웹소켓 연결이 예기치 않게 끊어졌을 때를 감지하고, 사람의 개입 없이 스스로 연결을 복구하려는 시도입니다.

언제 필요한가요?
- 스마트폰이 터널에 들어가거나 Wi-Fi에서 LTE로 전환될 때
- 서버가 잠시 점검을 위해 재부팅될 때
- 일시적인 네트워크 오류가 발생했을 때

구현 방법:
- 연결 끊김 감지: 웹소켓 라이브러리는 보통 연결이 끊겼을 때 호출되는 이벤트 핸들러(예: onclose, onerror)를 제공합니다.
- 재연결 시도: 이 이벤트 핸들러 안에서 다시 연결을 시도하는 함수를 호출하도록 코드를 작성합니다.

백오프 방법: 
- 만약 재연결을 시도했는데 서버가 응답하지 않는다면(서버 장애 등), 0.1초 만에 또 시도하고, 또 실패했다고 0.1초 만에 시도하면 어떻게 될까요? 전 세계 수만 개의 클라이언트가 동시에 이런 행동을 한다면, 서버는 재연결 요청 폭주로 인해 복구되자마자 다시 다운될 수 있습니다.
- 백오프는 바로 이런 문제를 막기 위한 '매너 있는 재시도' 전략입니다.
    - 핵심 원리: 재연결에 실패할수록 다음 시도까지의 대기 시간을 점차 늘려서 서버에 가해지는 부담을 줄입니다.
- 대표적인 백오프 전략: 지수 백오프 (Exponential Backoff)
    - 가장 널리 쓰이는 방식으로, 대기 시간을 2배씩 기하급수적으로 늘립니다.


### 압축

업비트 WebSocket 서버는 더 빠르고 효율적인 데이터 전송을 위해 압축(Compression) 기능을 제공합니다.

사용중인 WebSocket 클라이언트 또는 라이브러리에서 압축 옵션을 지원하는 경우, 해당 옵션을 활성화하여 압축 형식으로 데이터를 주고 받을 수 있습니다.
전송 구간이 종료되면 압축 데이터는 클라이언트 또는 라이브러리에 의해 압축 해제되어 제공되므로, 사용자는 옵션의 사용 여부와 상관 없이 Raw 데이터를 수신하여 사용할 수 있습니다. 따라서 별도의 압축 관련 구현은 요구되지 않습니다

